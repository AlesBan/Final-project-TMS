@using WebApp_Data.Models.Music
@using WebApp_Data.Models.SpotifyModels.DTO
@inject IEnumerable<ArtistDto> Artists;
@inject IEnumerable<TrackDto> Tracks;



@{
    ViewData["Title"] = "Search";
    Artists = ViewBag.Artists != null ? ((IEnumerable<ArtistDto>)ViewBag.Artists).ToList() : new List<ArtistDto>();
    Tracks = ViewBag.Tracks != null ? ((IEnumerable<TrackDto>)ViewBag.Tracks).ToList() : new List<TrackDto>();
}

@section Styles{
    <link href="~/css/Search.css" rel="stylesheet" type="text/css"/>
}

@section Searchdiv{
    <div class="header-actions">
        <div class="header-search input-group has-left-icon has-right-icon can-delete">
            <span class="left-icon-search"></span>
            <input type="text" id="search" class="input" placeholder="Найти трек">
            <span class="right-icon-search"></span>
        </div>
    </div>
}


<section class="section">
    <table class="table">
        <tr>
            <th>
                <h2 class="section-title">Треки</h2>
            </th>
            <th>
                <h4 class="popularity">Популярность</h4>
            </th>
        </tr>


        @if (Tracks.Any())
        {
            foreach (var item in Tracks)
            {
                <tr>
                    <td>
                        <div class="track">
                            <div class="trackInfo">
                                <a href=@Html.DisplayFor(modelItem => item.Href)>
                                    <img src="@Html.DisplayFor(modelItem => item.ImageRef)" alt="">
                                </a>
                            </div>
                            <div class="track-content">
                                <div class="trackName">@Html.DisplayFor(modelItem => item.Name)</div>
                                <div class="artist">@Html.DisplayFor(modelItem => item.ArtistName)</div>
                            </div>
                        </div>
                    </td>
                    <td>13</td>
                    <td>4:11</td>
                    <td>
                        <div class="dropdown">
                            <button type="button" class="floating-button">Добавить</button>
                            <div class="dropdown-content" id="@item.Id">
                                @foreach (var playlist in (IEnumerable<Playlist>)ViewBag.Playlists)
                                {
                                    <a class="dropdown-a" id="@playlist.PlaylistId">@playlist.Name</a>
                                }
                            </div>
                        </div>
                    </td>
                </tr>
            }
        }
    </table>
</section>


@* <div class="section-content"> *@
@* *@
@*                 <div class="track"> *@
@*                     <div class="trackInfo"> *@
@*                         <a href=@Html.DisplayFor(modelItem => item.Href)> *@
@*                             <img src="@Html.DisplayFor(modelItem => item.ImageRef)" alt=""> *@
@*                         </a> *@
@*                     </div> *@
@*                     <div class="track-content"> *@
@*                         <div class="trackName">@Html.DisplayFor(modelItem => item.Name)</div> *@
@*                         <div class="artist">@Html.DisplayFor(modelItem => item.ArtistName)</div> *@
@*                     </div> *@
@*                 </div> *@
@*                 <div class="trackPopularity">12</div> *@
@*                 <div class="trackTime">4:11</div> *@
@*                 <div class="add-btn"> *@
@*                     <div class="dropdown"> *@
@*                         <button class="floating-button btn-primary">Add</button> *@
@*                         <div class="dropdown-content" id="@item.Id"> *@
@*                             @foreach (var playlist in (IEnumerable<Playlist>)ViewBag.Playlists) *@
@*                             { *@
@*                                 <button style="color: white; font-size: 13px" class="add-dropdown-button" id="@playlist.PlaylistId">@playlist.Name</button> *@
@*                             } *@
@*                         </div> *@
@*                     </div> *@
@*                 </div> *@
@*             </div> *@
@* <section class="section"> *@
@*     <h2 class="section-title">Свежие релизы</h2> *@
@*     <div class="section-body"> *@
@*         @if (Model.Any()) *@
@*         { *@
@*             @foreach (var item in Model.Where(i => i.GetType() == typeof(ArtistDto))) *@
@*             { *@
@*                 <div class="card m-1" style="width:200px;"> *@
@*                     <div class="card-body"> *@
@*                         <img style="color: #a2ded8" src="@Html.DisplayFor(modelItem => item.ImageRef)" width="150" height="150" alt="Release picture"/> *@
@*                         <h6 class="card-subtitle mb-2 text-muted" style="color: #a2ded8">@Html.DisplayFor(modelItem => item.Name)</h6> *@
@*                         <a href="@Html.DisplayFor(modelItem => item.Href)" target="_blank">Listen</a> *@
@*                     </div> *@
@*                 </div> *@
@*             } *@
@*         } *@
@*         else *@
@*         { *@
@*             <p style="color: white">No data available</p> *@
@*         } *@
@*     </div> *@
@* </section> *@

@section Scripts
{
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <script>
     $(function (){
        let buttons = document.querySelectorAll("a.dropdown-a"); 
            buttons.forEach((butt)=>{
                butt.addEventListener("click", (e) => SendData(e), false)
                
            })
     })
     
    function SendData(event) {
        let playlistId = event.target.id;
        let parent = document.getElementById(playlistId).parentNode
        let trackId = parent.id;
        $.post("@Url.Action("CheckTrackPresenceInPlaylist", "Home")", {trackId: trackId, playlistId: playlistId}, function (presence) {   
            if (JSON.parse(presence) === true){
                alert("Данный трек уже добавлен в плейлист")
            }
            else {
                $.post("@Url.Action("AddTrackToPlaylist", "Home")", {trackId: trackId, playlistId: playlistId})
            }
        });   
    }
    </script>
}