@using WebApp_Data.Models.Music
@using WebApp_Data.Models.SpotifyModels.DTO
@inject IEnumerable<ArtistDto> Artists;
@inject IEnumerable<TrackDto> Tracks;

@{
    ViewData["Title"] = "Search";
    Artists = ViewBag.Artists != null ? ((IEnumerable<ArtistDto>)ViewBag.Artists).ToList() : new List<ArtistDto>();
    Tracks = ViewBag.Tracks != null ? ((IEnumerable<TrackDto>)ViewBag.Tracks).ToList() : new List<TrackDto>();
}

@section Styles{
    <link href="~/css/Search.css" rel="stylesheet" type="text/css"/>
}

@section Searchdiv{
    <div class="header-actions">
        <div class="header-search input-group has-left-icon has-right-icon can-delete">
            <span class="left-icon-search"></span>
            <input type="text" id="search-field" class="input" placeholder="Найти трек">
            <span class="right-icon-search"></span>
        </div>
        <button onclick="Search()">Поиск</button>
    </div>
}


<section class="section">
    <table class="table">
        <tr>
            <th>
                <h2 class="section-title">Треки</h2>
            </th>
            <th>
                <h4 class="popularity">Популярность</h4>
            </th>
        </tr>


        @if (Tracks.Any())
        {
            foreach (var item in Tracks)
            {
                <tr>
                    <td>
                        <div class="track">
                            <div class="trackInfo">
                                <a href=@Html.DisplayFor(modelItem => item.Href)>
                                    <img src="@Html.DisplayFor(modelItem => item.ImageRef)" alt="">
                                </a>
                            </div>
                            <div class="track-content">
                                <div class="trackName">@Html.DisplayFor(modelItem => item.Name)</div>
                                <div class="artist">@Html.DisplayFor(modelItem => item.ArtistName)</div>
                            </div>
                        </div>
                    </td>
                    <td>13</td>
                    <td>4:11</td>
                    <td>
                        <div class="dropdown">
                            <button type="button" class="floating-button">Добавить</button>
                            <div class="dropdown-content" id="@item.Id">
                                @foreach (var playlist in (IEnumerable<Playlist>)ViewBag.Playlists)
                                {
                                    <a class="dropdown-a" id="@playlist.PlaylistId">@playlist.Name</a>
                                }
                            </div>
                        </div>
                    </td>
                </tr>
            }
        }
    </table>
</section>

@section Scripts
{
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <script>
    function Search(){
        let serchQuery = document.getElementById("search-field").value;
        window.open("/search/"+serchQuery, "_self");
    }
    
     $(function (){
        let buttons = document.querySelectorAll("a.dropdown-a"); 
            buttons.forEach((butt)=>{
                butt.addEventListener("click", (e) => SendData(e), false)
            })
     })
     
    function SendData(event) {
        let playlistId = event.target.id;
        let parent = event.target.parentNode
        let trackId = parent.id;
        $.get("@Url.Action("CheckTrackAbilityToBeAdded", "Track")", {trackId: trackId, playlistId: playlistId}, function (CheckTrackAbility) {
            let obj = JSON.parse(CheckTrackAbility);
            if (obj.exceeding_the_limit === true){
                alert("Лимит на добавление исчерпан (10)")
            }
            else if (obj.track_duplication === true){
                alert("Этот трек вы уже добавили в плейлист")
                }
            else {
                $.post("@Url.Action("AddTrackToPlaylist", "Track")", {trackId: trackId, playlistId: playlistId})
            }
        });   
    }
    </script>
}